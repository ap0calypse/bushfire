#!/usr/bin/perl
use strict;
use Curses;
use Time::HiRes qw(usleep);


# name:     bushfire
# author:   Manuel Fill (ap0calypse@agitatio.org)
# license:  if not specified, it's under GPL

my $area;

print "Welcome to bushfire!\n" .
      "The program needs some information now:\n\n";

print "How long should the area be? (leave blank for maximum): ";
chomp(my $length = <STDIN>);
print "How high should the area be? (leave blank for maximum): ";
chomp(my $height = <STDIN>);
print "Percentage for starting a fire (leave blank for default; default is 5): ";
chomp(my $percentage = <STDIN>);
print "Microseconds between screen refreshs (leave blank for default; default is 100000): ";
chomp(my $microsecs = <STDIN>);

my $max_veg = 3;
$microsecs = 100000 if $microsecs !~ m/\d+/;
$percentage = 5 if $percentage !~ m/\d+/;

initscr;
if($length eq "" || $length > $COLS - 2) { $length = $COLS - 2; }
if($height eq "" || $height > $LINES - 3) { $height = $LINES - 3; }

for my $x (1 .. $length) {
    for my $y (1 .. $height) {
        $area->{"$x:$y"} = int rand($max_veg) + 1;
    }
}

my ($f, $f_b, $f_0, $f_1, $f_2, $f_3) = (0,0,0,0,0,0);
my ($win, $coords, $cycle);
sub print_area {
    $cycle = shift;
    clear;
    noecho;

    start_color;
    init_pair(1, 1, 0); # ACTIVE FIRE
    init_pair(2, 0, 0); # BURNT FIELD
    init_pair(3, 11, 0); # GRASS
    init_pair(4, 2, 0); # SHRUBS
    init_pair(5, 10, 0); # TREES
    $win = newwin($height + 2, $length + 2, 0, 0);
    box($win,0,0);
    my ($x, $y);
    for $coords (keys %{$area}) {
        $f++;
         if ($area->{$coords} == 0) { # burn motherfucker .. burn
            $f_0++;
            attron($win,COLOR_PAIR(1));
            attron($win,A_BOLD);
            ($x, $y) = split /:/, $coords;
            addstr($win, $y, $x, 'W');
            attroff($win,A_BOLD);
            attroff($win,COLOR_PAIR(1));
         }
         elsif ($area->{$coords} < 0) { # empty, burned field 
            $f_b++;
            attron($win,COLOR_PAIR(2));
            ($x, $y) = split /:/, $coords;
            addstr($win, $y, $x, '');
            attroff($win,COLOR_PAIR(2));
         }
         elsif ($area->{$coords} == 1) { # small vegetation very likely to burn
            $f_1++;
            attron($win,COLOR_PAIR(3));
            ($x, $y) = split /:/, $coords;
            addstr($win, $y, $x, '*');
            attroff($win,COLOR_PAIR(3));
         }
         elsif ($area->{$coords} == 2 ) { # normal vegetation
            $f_2++;
            attron($win,COLOR_PAIR(4));
            ($x, $y) = split /:/, $coords;
            addstr($win,$y, $x, '#');
            attroff($win,COLOR_PAIR(4));
         }
         else { # heavy rainforest, very unlikely to burn
            $f_3++;
            attron($win,COLOR_PAIR(5)); 
            ($x, $y) = split /:/, $coords;
            addstr($win, $y, $x, '@');
            attroff($win,COLOR_PAIR(5));
         }
    }
    ($x,$y) = (undef, undef);
    attron(COLOR_PAIR(1));
    addstr($win, 0,2 , "| cycle: $cycle | fields: $f | burning: $f_0 | " .
                       "burnt: $f_b |");
    addstr($win, $height+1,2,"| grass (*): $f_1 | shrubs (#): $f_2 | trees (\@): $f_3 |");
    attroff(COLOR_PAIR(1));
    refresh($win);
    doupdate;
    delwin($win);
    ($f, $f_b, $f_0, $f_1, $f_2, $f_3) = (0,0,0,0,0,0);
}

my @burnables;
sub start_fire {
    for (keys %{$area}) {
        if ($area->{$_} == 1) {
            push @burnables, $_;
        }
    }
    my $random = rand scalar @burnables;
    $area->{$burnables[$random]}-- if defined $area->{$burnables[$random]};
    @burnables = undef;
}

my $cy = 0;
my (%decrement, $xy, $X, $Y, $x, $y, $l_x, $u_x, $l_y, $u_y);
while (1) {
    $cy++;
    if (int rand(100) < $percentage) { 
        &start_fire;
    }
    for $xy (keys %{$area}) {
        if ($area->{$xy} == 0) {
            ($x, $y) = split /:/, $xy;
            ($l_x, $u_x, $l_y, $u_y) = ($x-1,$x+1,$y-1,$y+1);
            $area->{"$x:$y"}-- if defined $area->{"$x:$y"};
            for $X ($l_x .. $u_x) {
                for $Y ($l_y .. $u_y) {
                    $decrement{"$X:$Y"} += 1 if defined $area->{"$X:$Y"} and ("$X:$Y" ne "$x:$y");
                }
            }
            ($X,$Y) = (undef,undef);
        }
        if (($cy%100) == 0) { # plants grow, ...
            $area->{$xy} += (int rand(2)) if $area->{$xy} > 0 && $area->{$xy} < $max_veg;
            $area->{$xy} = (int(rand 2) + 1) if $area->{$xy} < 0;
        }
        if (($cy%333) == 0) { # ... and die
            $area->{$xy} -= (int rand(2)) if $area->{$xy} >= $max_veg;
            $area->{$xy} -= (int rand(2)) if $area->{$xy} == 2;
        }
    }
    for (keys %decrement) { # burn it down
        if (($area->{$_} - $decrement{$_}) < 1) {
            $area->{$_} -= $decrement{$_};
        }
    }
    %decrement = ();
    &print_area($cy);
    usleep($microsecs);
    ($xy, $x, $y, $X, $Y, $l_x, $u_x, $l_y, $u_y) = 
    (undef, undef, undef, undef, undef, undef, undef, undef, undef);
}
